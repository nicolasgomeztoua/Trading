//@version=5
indicator("Daily High/Low Marker", overlay=true, max_lines_count=6, max_labels_count=6)

// Current Day Settings
highColor     = input.color(color.new(color.red, 0), "High Line Color", group="Current Day")
lowColor      = input.color(color.new(color.teal, 0), "Low Line Color", group="Current Day")
dayLineStyle  = input.string("Dotted", "Line Style", options=["Solid", "Dashed", "Dotted"], group="Current Day")

// Previous Day Settings
prevHighColor = input.color(color.new(color.orange, 0), "High Line Color", group="Previous Day")
prevLowColor  = input.color(color.new(color.purple, 0), "Low Line Color", group="Previous Day")
prevDayLineStyle = input.string("Dashed", "Line Style", options=["Solid", "Dashed", "Dotted"], group="Previous Day")

// Previous Week Settings
prevWeekHighColor = input.color(color.new(color.blue, 0), "High Line Color", group="Previous Week")
prevWeekLowColor  = input.color(color.new(color.lime, 0), "Low Line Color", group="Previous Week")
prevWeekLineStyle = input.string("Solid", "Line Style", options=["Solid", "Dashed", "Dotted"], group="Previous Week")

// General Settings
lineWidth     = input.int(1, "Line Width", minval=1, maxval=4, group="General")

// Helper function to convert string to line style
getLineStyle(styleStr) =>
    switch styleStr
        "Solid" => line.style_solid
        "Dashed" => line.style_dashed
        "Dotted" => line.style_dotted
        => line.style_solid

dayStyle = getLineStyle(dayLineStyle)
prevDayStyle = getLineStyle(prevDayLineStyle)
prevWeekStyle = getLineStyle(prevWeekLineStyle)

var float dayHigh = na
var float dayLow  = na
var int   highBarIndex = na
var int   lowBarIndex  = na
var line  highLine = na
var line  lowLine  = na
var label highLabel = na
var label lowLabel  = na
var float prevDayHigh = na
var float prevDayLow  = na
var int   prevHighBarIndex = na
var int   prevLowBarIndex  = na
var line  prevHighLine = na
var line  prevLowLine  = na
var label prevHighLabel = na
var label prevLowLabel  = na
var bool  prevHighCrossed = false
var bool  prevLowCrossed  = false
var int   prevHighCrossBarIndex = na
var int   prevLowCrossBarIndex  = na

// Weekly tracking variables (using time instead of bar_index to avoid distance limitations)
var float weekHigh = na
var float weekLow  = na
var int   weekHighTime = na
var int   weekLowTime  = na
var float prevWeekHigh = na
var float prevWeekLow  = na
var int   prevWeekHighTime = na
var int   prevWeekLowTime  = na
var line  prevWeekHighLine = na
var line  prevWeekLowLine  = na
var label prevWeekHighLabel = na
var label prevWeekLowLabel  = na
var bool  prevWeekHighCrossed = false
var bool  prevWeekLowCrossed  = false
var int   prevWeekHighCrossTime = na
var int   prevWeekLowCrossTime  = na

newDay = ta.change(time("D")) != 0
newWeek = ta.change(time("W")) != 0
startOfDay = newDay or na(dayHigh) or na(dayLow)

if startOfDay
    if not na(prevHighLine)
        line.delete(prevHighLine)
    if not na(prevLowLine)
        line.delete(prevLowLine)
    if not na(prevHighLabel)
        label.delete(prevHighLabel)
    if not na(prevLowLabel)
        label.delete(prevLowLabel)

    prevHighLine := na
    prevLowLine := na
    prevHighLabel := na
    prevLowLabel := na
    prevHighCrossed := false
    prevLowCrossed := false
    prevHighCrossBarIndex := na
    prevLowCrossBarIndex := na

    if not na(dayHigh) and not na(dayLow) and not na(highBarIndex) and not na(lowBarIndex)
        prevDayHigh := dayHigh
        prevDayLow := dayLow
        prevHighBarIndex := highBarIndex
        prevLowBarIndex := lowBarIndex

        prevHighLine := line.new(prevHighBarIndex, prevDayHigh, prevHighBarIndex + 1, prevDayHigh, extend=extend.right, color=prevHighColor, width=lineWidth, style=prevDayStyle)
        prevLowLine  := line.new(prevLowBarIndex,  prevDayLow,  prevLowBarIndex + 1,  prevDayLow,  extend=extend.right, color=prevLowColor,  width=lineWidth, style=prevDayStyle)

        prevHighLabel := label.new(prevHighBarIndex, prevDayHigh, text="PDH", style=label.style_label_down, textcolor=prevHighColor, color=color.new(prevHighColor, 80), size=size.tiny)
        prevLowLabel  := label.new(prevLowBarIndex,  prevDayLow,  text="PDL", style=label.style_label_up,   textcolor=prevLowColor,  color=color.new(prevLowColor, 80), size=size.tiny)
    else
        prevDayHigh := na
        prevDayLow := na
        prevHighBarIndex := na
        prevLowBarIndex := na
        prevHighCrossed := false
        prevLowCrossed := false
        prevHighCrossBarIndex := na
        prevLowCrossBarIndex := na

    dayHigh := high
    dayLow := low
    highBarIndex := bar_index
    lowBarIndex := bar_index

    if not na(highLine)
        line.delete(highLine)
    if not na(lowLine)
        line.delete(lowLine)
    if not na(highLabel)
        label.delete(highLabel)
    if not na(lowLabel)
        label.delete(lowLabel)

    highLine := line.new(highBarIndex, dayHigh, highBarIndex + 1, dayHigh, extend=extend.right, color=highColor, width=lineWidth, style=dayStyle)
    lowLine  := line.new(lowBarIndex,  dayLow,  lowBarIndex + 1,  dayLow,  extend=extend.right, color=lowColor,  width=lineWidth, style=dayStyle)

    highLabel := label.new(highBarIndex, dayHigh, text="DH", style=label.style_label_down, textcolor=highColor, color=color.new(highColor, 80), size=size.tiny)
    lowLabel  := label.new(lowBarIndex,  dayLow,  text="DL", style=label.style_label_up,   textcolor=lowColor,  color=color.new(lowColor, 80), size=size.tiny)
else
    if high > dayHigh
        dayHigh := high
        highBarIndex := bar_index
        if not na(highLabel)
            label.delete(highLabel)
        highLabel := label.new(highBarIndex, dayHigh, text="DH", style=label.style_label_down, textcolor=highColor, color=color.new(highColor, 80), size=size.tiny)
        if na(highLine)
            highLine := line.new(highBarIndex, dayHigh, highBarIndex + 1, dayHigh, extend=extend.right, color=highColor, width=lineWidth, style=dayStyle)
    if low < dayLow or na(dayLow)
        dayLow := low
        lowBarIndex := bar_index
        if not na(lowLabel)
            label.delete(lowLabel)
        lowLabel := label.new(lowBarIndex, dayLow, text="DL", style=label.style_label_up, textcolor=lowColor, color=color.new(lowColor, 80), size=size.tiny)
        if na(lowLine)
            lowLine := line.new(lowBarIndex, dayLow, lowBarIndex + 1, dayLow, extend=extend.right, color=lowColor, width=lineWidth, style=dayStyle)

// Weekly high/low tracking
if newWeek
    // Clean up old previous week lines/labels
    if not na(prevWeekHighLine)
        line.delete(prevWeekHighLine)
    if not na(prevWeekLowLine)
        line.delete(prevWeekLowLine)
    if not na(prevWeekHighLabel)
        label.delete(prevWeekHighLabel)
    if not na(prevWeekLowLabel)
        label.delete(prevWeekLowLabel)

    prevWeekHighLine := na
    prevWeekLowLine := na
    prevWeekHighLabel := na
    prevWeekLowLabel := na
    prevWeekHighCrossed := false
    prevWeekLowCrossed := false
    prevWeekHighCrossTime := na
    prevWeekLowCrossTime := na

    // Store previous week's high/low if we have valid data
    if not na(weekHigh) and not na(weekLow) and not na(weekHighTime) and not na(weekLowTime)
        prevWeekHigh := weekHigh
        prevWeekLow := weekLow
        prevWeekHighTime := weekHighTime
        prevWeekLowTime := weekLowTime

        prevWeekHighLine := line.new(prevWeekHighTime, prevWeekHigh, time, prevWeekHigh, extend=extend.right, color=prevWeekHighColor, width=lineWidth, style=prevWeekStyle, xloc=xloc.bar_time)
        prevWeekLowLine  := line.new(prevWeekLowTime,  prevWeekLow,  time, prevWeekLow,  extend=extend.right, color=prevWeekLowColor,  width=lineWidth, style=prevWeekStyle, xloc=xloc.bar_time)

        prevWeekHighLabel := label.new(prevWeekHighTime, prevWeekHigh, text="PWH", style=label.style_label_down, textcolor=prevWeekHighColor, color=color.new(prevWeekHighColor, 80), size=size.tiny, xloc=xloc.bar_time)
        prevWeekLowLabel  := label.new(prevWeekLowTime,  prevWeekLow,  text="PWL", style=label.style_label_up,   textcolor=prevWeekLowColor,  color=color.new(prevWeekLowColor, 80), size=size.tiny, xloc=xloc.bar_time)
    else
        prevWeekHigh := na
        prevWeekLow := na
        prevWeekHighTime := na
        prevWeekLowTime := na
        prevWeekHighCrossed := false
        prevWeekLowCrossed := false
        prevWeekHighCrossTime := na
        prevWeekLowCrossTime := na

    // Reset current week tracking
    weekHigh := high
    weekLow := low
    weekHighTime := time
    weekLowTime := time
else
    // Update current week high/low
    if high > weekHigh or na(weekHigh)
        weekHigh := high
        weekHighTime := time
    if low < weekLow or na(weekLow)
        weekLow := low
        weekLowTime := time

// Previous week high/low cross detection
prevWeekHighCross = not prevWeekHighCrossed and not na(prevWeekHigh) and not na(prevWeekHighLine) and high > prevWeekHigh
prevWeekLowCross  = not prevWeekLowCrossed and not na(prevWeekLow) and not na(prevWeekLowLine) and low < prevWeekLow

if prevWeekHighCross
    prevWeekHighCrossed := true
    prevWeekHighCrossTime := time
    line.set_x2(prevWeekHighLine, prevWeekHighCrossTime)
    line.set_extend(prevWeekHighLine, extend.none)

if prevWeekLowCross
    prevWeekLowCrossed := true
    prevWeekLowCrossTime := time
    line.set_x2(prevWeekLowLine, prevWeekLowCrossTime)
    line.set_extend(prevWeekLowLine, extend.none)

prevDayHighCross = not prevHighCrossed and not na(prevDayHigh) and not na(prevHighLine) and high > prevDayHigh
prevDayLowCross  = not prevLowCrossed and not na(prevDayLow) and not na(prevLowLine) and low < prevDayLow

if prevDayHighCross
    prevHighCrossed := true
    prevHighCrossBarIndex := bar_index
    line.set_x2(prevHighLine, prevHighCrossBarIndex)
    line.set_extend(prevHighLine, extend.none)

if prevDayLowCross
    prevLowCrossed := true
    prevLowCrossBarIndex := bar_index
    line.set_x2(prevLowLine, prevLowCrossBarIndex)
    line.set_extend(prevLowLine, extend.none)

if not na(highLine)
    line.set_x1(highLine, highBarIndex)
    line.set_x2(highLine, bar_index)
    line.set_y1(highLine, dayHigh)
    line.set_y2(highLine, dayHigh)
    line.set_color(highLine, highColor)
    line.set_width(highLine, lineWidth)
    line.set_style(highLine, dayStyle)

if not na(lowLine)
    line.set_x1(lowLine, lowBarIndex)
    line.set_x2(lowLine, bar_index)
    line.set_y1(lowLine, dayLow)
    line.set_y2(lowLine, dayLow)
    line.set_color(lowLine, lowColor)
    line.set_width(lowLine, lineWidth)
    line.set_style(lowLine, dayStyle)

if not na(highLabel)
    label.set_x(highLabel, highBarIndex)
    label.set_y(highLabel, dayHigh)
    label.set_text(highLabel, "DH")
    label.set_textcolor(highLabel, highColor)
    label.set_color(highLabel, color.new(highColor, 80))
    label.set_size(highLabel, size.tiny)
    label.set_style(highLabel, label.style_label_down)

if not na(lowLabel)
    label.set_x(lowLabel, lowBarIndex)
    label.set_y(lowLabel, dayLow)
    label.set_text(lowLabel, "DL")
    label.set_textcolor(lowLabel, lowColor)
    label.set_color(lowLabel, color.new(lowColor, 80))
    label.set_size(lowLabel, size.tiny)
    label.set_style(lowLabel, label.style_label_up)

if not na(prevHighLine)
    line.set_x1(prevHighLine, prevHighBarIndex)
    line.set_x2(prevHighLine, prevHighCrossed ? prevHighCrossBarIndex : bar_index)
    line.set_y1(prevHighLine, prevDayHigh)
    line.set_y2(prevHighLine, prevDayHigh)
    line.set_color(prevHighLine, prevHighColor)
    line.set_width(prevHighLine, lineWidth)
    line.set_style(prevHighLine, prevDayStyle)
    line.set_extend(prevHighLine, prevHighCrossed ? extend.none : extend.right)

if not na(prevLowLine)
    line.set_x1(prevLowLine, prevLowBarIndex)
    line.set_x2(prevLowLine, prevLowCrossed ? prevLowCrossBarIndex : bar_index)
    line.set_y1(prevLowLine, prevDayLow)
    line.set_y2(prevLowLine, prevDayLow)
    line.set_color(prevLowLine, prevLowColor)
    line.set_width(prevLowLine, lineWidth)
    line.set_style(prevLowLine, prevDayStyle)
    line.set_extend(prevLowLine, prevLowCrossed ? extend.none : extend.right)

if not na(prevHighLabel)
    label.set_x(prevHighLabel, prevHighBarIndex)
    label.set_y(prevHighLabel, prevDayHigh)
    label.set_text(prevHighLabel, "PDH")
    label.set_textcolor(prevHighLabel, prevHighColor)
    label.set_color(prevHighLabel, color.new(prevHighColor, 80))
    label.set_size(prevHighLabel, size.tiny)
    label.set_style(prevHighLabel, label.style_label_down)

if not na(prevLowLabel)
    label.set_x(prevLowLabel, prevLowBarIndex)
    label.set_y(prevLowLabel, prevDayLow)
    label.set_text(prevLowLabel, "PDL")
    label.set_textcolor(prevLowLabel, prevLowColor)
    label.set_color(prevLowLabel, color.new(prevLowColor, 80))
    label.set_size(prevLowLabel, size.tiny)
    label.set_style(prevLowLabel, label.style_label_up)

// Update previous week high line (using time-based xloc)
if not na(prevWeekHighLine)
    line.set_x1(prevWeekHighLine, prevWeekHighTime)
    line.set_x2(prevWeekHighLine, prevWeekHighCrossed ? prevWeekHighCrossTime : time)
    line.set_y1(prevWeekHighLine, prevWeekHigh)
    line.set_y2(prevWeekHighLine, prevWeekHigh)
    line.set_color(prevWeekHighLine, prevWeekHighColor)
    line.set_width(prevWeekHighLine, lineWidth)
    line.set_style(prevWeekHighLine, prevWeekStyle)
    line.set_extend(prevWeekHighLine, prevWeekHighCrossed ? extend.none : extend.right)

// Update previous week low line (using time-based xloc)
if not na(prevWeekLowLine)
    line.set_x1(prevWeekLowLine, prevWeekLowTime)
    line.set_x2(prevWeekLowLine, prevWeekLowCrossed ? prevWeekLowCrossTime : time)
    line.set_y1(prevWeekLowLine, prevWeekLow)
    line.set_y2(prevWeekLowLine, prevWeekLow)
    line.set_color(prevWeekLowLine, prevWeekLowColor)
    line.set_width(prevWeekLowLine, lineWidth)
    line.set_style(prevWeekLowLine, prevWeekStyle)
    line.set_extend(prevWeekLowLine, prevWeekLowCrossed ? extend.none : extend.right)

// Update previous week high label (using time-based xloc)
if not na(prevWeekHighLabel)
    label.set_x(prevWeekHighLabel, prevWeekHighTime)
    label.set_y(prevWeekHighLabel, prevWeekHigh)
    label.set_text(prevWeekHighLabel, "PWH")
    label.set_textcolor(prevWeekHighLabel, prevWeekHighColor)
    label.set_color(prevWeekHighLabel, color.new(prevWeekHighColor, 80))
    label.set_size(prevWeekHighLabel, size.tiny)
    label.set_style(prevWeekHighLabel, label.style_label_down)

// Update previous week low label (using time-based xloc)
if not na(prevWeekLowLabel)
    label.set_x(prevWeekLowLabel, prevWeekLowTime)
    label.set_y(prevWeekLowLabel, prevWeekLow)
    label.set_text(prevWeekLowLabel, "PWL")
    label.set_textcolor(prevWeekLowLabel, prevWeekLowColor)
    label.set_color(prevWeekLowLabel, color.new(prevWeekLowColor, 80))
    label.set_size(prevWeekLowLabel, size.tiny)
    label.set_style(prevWeekLowLabel, label.style_label_up)
