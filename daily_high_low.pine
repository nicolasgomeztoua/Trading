//@version=5
indicator("Session Reference Lines", overlay=true, max_lines_count=20)

lineColor = input.color(color.new(color.gray, 0), "Line Color")
lineWidth = input.int(1, "Line Width", minval=1, maxval=4)
showIntraday = input.bool(true, "Show Intraday Reference Lines")
showWeekOpen = input.bool(true, "Show Weekly Open")
showMonthOpen = input.bool(true, "Show Monthly Open")
showQuarterOpen = input.bool(true, "Show Quarterly Open")
showYearOpen = input.bool(true, "Show Yearly Open")

var int[] intradayHours = array.from(0, 6, 8, 9, 13)
var int[] intradayMinutes = array.from(0, 0, 30, 30, 30)
var line[] intradayLines = array.new_line(array.size(intradayHours), na)

var line weekLine = na
var line monthLine = na
var line quarterLine = na
var line yearLine = na

newDay = ta.change(time("D")) != 0
if newDay
    for i = 0 to array.size(intradayLines) - 1
        existing = array.get(intradayLines, i)
        if not na(existing)
            line.delete(existing)
        array.set(intradayLines, i, na)

if showIntraday
    for i = 0 to array.size(intradayHours) - 1
        targetHour = array.get(intradayHours, i)
        targetMinute = array.get(intradayMinutes, i)
        if hour == targetHour and minute == targetMinute
            existing = array.get(intradayLines, i)
            if not na(existing)
                line.delete(existing)
            intradayLine = line.new(bar_index, open, bar_index + 1, open, extend=extend.right, color=lineColor, width=lineWidth, style=line.style_dotted)
            array.set(intradayLines, i, intradayLine)
else
    for i = 0 to array.size(intradayLines) - 1
        existing = array.get(intradayLines, i)
        if not na(existing)
            line.delete(existing)
        array.set(intradayLines, i, na)

newWeek = ta.change(time("W")) != 0
newMonth = ta.change(time("M")) != 0
newQuarter = newMonth and (month == 1 or month == 4 or month == 7 or month == 10)
newYear = year != nz(year[1], year)

if showWeekOpen
    if newWeek
        if not na(weekLine)
            line.delete(weekLine)
        weekLine := line.new(bar_index, open, bar_index + 1, open, extend=extend.right, color=lineColor, width=lineWidth, style=line.style_dotted)
else if not na(weekLine)
    line.delete(weekLine)
    weekLine := na

if showMonthOpen
    if newMonth
        if not na(monthLine)
            line.delete(monthLine)
        monthLine := line.new(bar_index, open, bar_index + 1, open, extend=extend.right, color=lineColor, width=lineWidth, style=line.style_dotted)
else if not na(monthLine)
    line.delete(monthLine)
    monthLine := na

if showQuarterOpen
    if newQuarter
        if not na(quarterLine)
            line.delete(quarterLine)
        quarterLine := line.new(bar_index, open, bar_index + 1, open, extend=extend.right, color=lineColor, width=lineWidth, style=line.style_dotted)
else if not na(quarterLine)
    line.delete(quarterLine)
    quarterLine := na

if showYearOpen
    if newYear
        if not na(yearLine)
            line.delete(yearLine)
        yearLine := line.new(bar_index, open, bar_index + 1, open, extend=extend.right, color=lineColor, width=lineWidth, style=line.style_dotted)
else if not na(yearLine)
    line.delete(yearLine)
    yearLine := na
