//@version=5
indicator("Higher Timeframe Open Marker", overlay=true, max_lines_count=3, max_labels_count=3)

lineWidth        = input.int(1, "Line Width", minval=1, maxval=4)
weekColor        = input.color(color.new(color.blue, 0), "Weekly Open Color")
monthColor       = input.color(color.new(color.orange, 0), "Monthly Open Color")
yearColor        = input.color(color.new(color.purple, 0), "Yearly Open Color")
labelTransparency = input.int(80, "Label Background Transparency", minval=0, maxval=100)

var float weekOpen = na
var int   weekBarIndex = na
var line  weekLine = na
var label weekLabel = na

var float monthOpen = na
var int   monthBarIndex = na
var line  monthLine = na
var label monthLabel = na

var float yearOpen = na
var int   yearBarIndex = na
var line  yearLine = na
var label yearLabel = na

newWeek = ta.change(time("W")) != 0
newMonth = ta.change(time("M")) != 0
newYear = ta.change(time("12M")) != 0

startOfWeek = newWeek or na(weekOpen)
startOfMonth = newMonth or na(monthOpen)
startOfYear = newYear or na(yearOpen)

if startOfWeek
    weekOpen := request.security(syminfo.tickerid, "W", open, lookahead=barmerge.lookahead_off)
    weekBarIndex := bar_index
    if not na(weekLine)
        line.delete(weekLine)
    if not na(weekLabel)
        label.delete(weekLabel)
    weekLine := line.new(weekBarIndex, weekOpen, weekBarIndex + 1, weekOpen, extend=extend.right, color=weekColor, width=lineWidth, style=line.style_dotted)
    weekLabel := label.new(weekBarIndex, weekOpen, text="WO", style=label.style_label_left, textcolor=weekColor, color=color.new(weekColor, labelTransparency), size=size.tiny)

if startOfMonth
    monthOpen := request.security(syminfo.tickerid, "M", open, lookahead=barmerge.lookahead_off)
    monthBarIndex := bar_index
    if not na(monthLine)
        line.delete(monthLine)
    if not na(monthLabel)
        label.delete(monthLabel)
    monthLine := line.new(monthBarIndex, monthOpen, monthBarIndex + 1, monthOpen, extend=extend.right, color=monthColor, width=lineWidth, style=line.style_dotted)
    monthLabel := label.new(monthBarIndex, monthOpen, text="MO", style=label.style_label_left, textcolor=monthColor, color=color.new(monthColor, labelTransparency), size=size.tiny)

if startOfYear
    yearOpen := request.security(syminfo.tickerid, "12M", open, lookahead=barmerge.lookahead_off)
    yearBarIndex := bar_index
    if not na(yearLine)
        line.delete(yearLine)
    if not na(yearLabel)
        label.delete(yearLabel)
    yearLine := line.new(yearBarIndex, yearOpen, yearBarIndex + 1, yearOpen, extend=extend.right, color=yearColor, width=lineWidth, style=line.style_dotted)
    yearLabel := label.new(yearBarIndex, yearOpen, text="YO", style=label.style_label_left, textcolor=yearColor, color=color.new(yearColor, labelTransparency), size=size.tiny)

if not na(weekLine)
    line.set_x1(weekLine, weekBarIndex)
    line.set_x2(weekLine, bar_index)
    line.set_y1(weekLine, weekOpen)
    line.set_y2(weekLine, weekOpen)
    line.set_color(weekLine, weekColor)
    line.set_width(weekLine, lineWidth)
    line.set_style(weekLine, line.style_dotted)

if not na(monthLine)
    line.set_x1(monthLine, monthBarIndex)
    line.set_x2(monthLine, bar_index)
    line.set_y1(monthLine, monthOpen)
    line.set_y2(monthLine, monthOpen)
    line.set_color(monthLine, monthColor)
    line.set_width(monthLine, lineWidth)
    line.set_style(monthLine, line.style_dotted)

if not na(yearLine)
    line.set_x1(yearLine, yearBarIndex)
    line.set_x2(yearLine, bar_index)
    line.set_y1(yearLine, yearOpen)
    line.set_y2(yearLine, yearOpen)
    line.set_color(yearLine, yearColor)
    line.set_width(yearLine, lineWidth)
    line.set_style(yearLine, line.style_dotted)

if not na(weekLabel)
    label.set_x(weekLabel, weekBarIndex)
    label.set_y(weekLabel, weekOpen)
    label.set_text(weekLabel, "WO")
    label.set_textcolor(weekLabel, weekColor)
    label.set_color(weekLabel, color.new(weekColor, labelTransparency))
    label.set_size(weekLabel, size.tiny)
    label.set_style(weekLabel, label.style_label_left)

if not na(monthLabel)
    label.set_x(monthLabel, monthBarIndex)
    label.set_y(monthLabel, monthOpen)
    label.set_text(monthLabel, "MO")
    label.set_textcolor(monthLabel, monthColor)
    label.set_color(monthLabel, color.new(monthColor, labelTransparency))
    label.set_size(monthLabel, size.tiny)
    label.set_style(monthLabel, label.style_label_left)

if not na(yearLabel)
    label.set_x(yearLabel, yearBarIndex)
    label.set_y(yearLabel, yearOpen)
    label.set_text(yearLabel, "YO")
    label.set_textcolor(yearLabel, yearColor)
    label.set_color(yearLabel, color.new(yearColor, labelTransparency))
    label.set_size(yearLabel, size.tiny)
    label.set_style(yearLabel, label.style_label_left)
